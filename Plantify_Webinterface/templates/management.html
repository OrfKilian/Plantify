{% extends "base.html" %}

{% block title %}Verwaltung - Plantify{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>Plantify Verwaltung</h2>
            <p class="text-muted">Verwalten Sie Ihre Pflanzen, Töpfe und Zuweisungen</p>
        </div>
    </div>

    <!-- Plant Management Section -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Pflanzen verwalten</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-3" onclick="showCreatePlantModal()">
                        <i class="fas fa-plus"></i> Neue Pflanze hinzufügen
                    </button>
                    <div id="plants-list">
                        <!-- Plants will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Töpfe verwalten</h5>
                </div>
                <div class="card-body">
                    <div id="pots-list">
                        <!-- Pots will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignment Management Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Zuweisungen verwalten</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Pflanzen-Topf Zuweisungen</h6>
                            <button class="btn btn-success mb-3" onclick="showPlantPotAssignmentModal()">
                                <i class="fas fa-link"></i> Pflanze zu Topf zuweisen
                            </button>
                            <div id="plant-pot-assignments">
                                <!-- Assignments will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Benutzer-Topf Zuweisungen</h6>
                            <button class="btn btn-success mb-3" onclick="showUserPotAssignmentModal()">
                                <i class="fas fa-user-plus"></i> Benutzer zu Topf zuweisen
                            </button>
                            <div id="user-pot-assignments">
                                <!-- Assignments will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Plant Modal -->
<div class="modal fade" id="createPlantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Neue Pflanze hinzufügen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPlantForm">
                    <div class="mb-3">
                        <label for="plantName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="plantName" required>
                    </div>
                    <div class="mb-3">
                        <label for="plantDescription" class="form-label">Beschreibung *</label>
                        <textarea class="form-control" id="plantDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="irrigationCycle" class="form-label">Bewässerungszyklus (Tage) *</label>
                        <input type="number" class="form-control" id="irrigationCycle" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="targetTemp" class="form-label">Zieltemperatur (°C) *</label>
                        <input type="number" class="form-control" id="targetTemp" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="targetSunlight" class="form-label">Ziel-Sonnenstunden *</label>
                        <input type="number" class="form-control" id="targetSunlight" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="targetAirHumidity" class="form-label">Ziel-Luftfeuchtigkeit (%) *</label>
                        <input type="number" class="form-control" id="targetAirHumidity" min="0" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="targetSoilMoisture" class="form-label">Ziel-Bodenfeuchtigkeit (%) *</label>
                        <input type="number" class="form-control" id="targetSoilMoisture" min="0" max="100" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="createPlant()">Pflanze erstellen</button>
            </div>
        </div>
    </div>
</div>

<!-- Plant-Pot Assignment Modal -->
<div class="modal fade" id="plantPotAssignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pflanze zu Topf zuweisen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="plantPotAssignmentForm">
                    <div class="mb-3">
                        <label for="selectPlant" class="form-label">Pflanze auswählen *</label>
                        <select class="form-select" id="selectPlant" required>
                            <option value="">Bitte wählen...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="selectPot" class="form-label">Topf auswählen *</label>
                        <select class="form-select" id="selectPot" required>
                            <option value="">Bitte wählen...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="createPlantPotAssignment()">Zuweisung erstellen</button>
            </div>
        </div>
    </div>
</div>

<!-- User-Pot Assignment Modal -->
<div class="modal fade" id="userPotAssignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Benutzer zu Topf zuweisen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userPotAssignmentForm">
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Benutzer E-Mail *</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="selectPotUser" class="form-label">Topf auswählen *</label>
                        <select class="form-select" id="selectPotUser" required>
                            <option value="">Bitte wählen...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="createUserPotAssignment()">Zuweisung erstellen</button>
            </div>
        </div>
    </div>
</div>

<script>
// Management functionality
document.addEventListener('DOMContentLoaded', function() {
    loadPlants();
    loadPots();
    loadAssignments();
});

function showCreatePlantModal() {
    const modal = new bootstrap.Modal(document.getElementById('createPlantModal'));
    modal.show();
}

function showPlantPotAssignmentModal() {
    loadPlantsForSelect();
    loadPotsForSelect();
    const modal = new bootstrap.Modal(document.getElementById('plantPotAssignmentModal'));
    modal.show();
}

function showUserPotAssignmentModal() {
    loadPotsForUserSelect();
    const modal = new bootstrap.Modal(document.getElementById('userPotAssignmentModal'));
    modal.show();
}

function createPlant() {
    const formData = {
        name: document.getElementById('plantName').value,
        description: document.getElementById('plantDescription').value,
        irrigation_cycle_days: parseInt(document.getElementById('irrigationCycle').value),
        target_temperature_celsius: parseFloat(document.getElementById('targetTemp').value),
        target_sunlight_hours: parseFloat(document.getElementById('targetSunlight').value),
        target_air_humidity_percent: parseInt(document.getElementById('targetAirHumidity').value),
        target_soil_moisture_percent: parseInt(document.getElementById('targetSoilMoisture').value)
    };

    fetch('/api/plants', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Fehler: ' + data.error);
        } else {
            alert('Pflanze erfolgreich erstellt!');
            bootstrap.Modal.getInstance(document.getElementById('createPlantModal')).hide();
            loadPlants();
            document.getElementById('createPlantForm').reset();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Erstellen der Pflanze');
    });
}

function deletePlant(plantId) {
    if (confirm('Sind Sie sicher, dass Sie diese Pflanze löschen möchten?')) {
        fetch(`/api/plants/${plantId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Fehler: ' + data.error);
            } else {
                alert('Pflanze erfolgreich gelöscht!');
                loadPlants();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Löschen der Pflanze');
        });
    }
}

function updatePot(potId, newName) {
    fetch(`/api/pots/${potId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({pot_name: newName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Fehler: ' + data.error);
        } else {
            alert('Topf erfolgreich aktualisiert!');
            loadPots();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Aktualisieren des Topfs');
    });
}

function deletePot(potId) {
    if (confirm('Sind Sie sicher, dass Sie diesen Topf löschen möchten?')) {
        fetch(`/api/pots/${potId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Fehler: ' + data.error);
            } else {
                alert('Topf erfolgreich gelöscht!');
                loadPots();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Löschen des Topfs');
        });
    }
}

function createPlantPotAssignment() {
    const plantId = document.getElementById('selectPlant').value;
    const potId = document.getElementById('selectPot').value;

    fetch('/api/plant-pot-assignments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({plant_id: plantId, pot_id: potId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Fehler: ' + data.error);
        } else {
            alert('Zuweisung erfolgreich erstellt!');
            bootstrap.Modal.getInstance(document.getElementById('plantPotAssignmentModal')).hide();
            loadAssignments();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Erstellen der Zuweisung');
    });
}

function createUserPotAssignment() {
    const userEmail = document.getElementById('userEmail').value;
    const potId = document.getElementById('selectPotUser').value;

    fetch('/api/user-pot-assignments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({user_id: userEmail, pot_id: potId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Fehler: ' + data.error);
        } else {
            alert('Zuweisung erfolgreich erstellt!');
            bootstrap.Modal.getInstance(document.getElementById('userPotAssignmentModal')).hide();
            loadAssignments();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Erstellen der Zuweisung');
    });
}

function loadPlants() {
    fetch('/json/plants?user_mail={{ session.user_id }}')
    .then(response => response.json())
    .then(plants => {
        const container = document.getElementById('plants-list');
        container.innerHTML = plants.map(plant => `
            <div class="card mb-2">
                <div class="card-body">
                    <h6 class="card-title">${plant.name}</h6>
                    <p class="card-text small">${plant.description}</p>
                    <button class="btn btn-sm btn-danger" onclick="deletePlant(${plant.plant_id})">
                        <i class="fas fa-trash"></i> Löschen
                    </button>
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading plants:', error);
    });
}

function loadPots() {
    fetch('/json/pots?user_mail={{ session.user_id }}')
    .then(response => response.json())
    .then(pots => {
        const container = document.getElementById('pots-list');
        container.innerHTML = pots.map(pot => `
            <div class="card mb-2">
                <div class="card-body">
                    <h6 class="card-title">${pot.pot_name || pot.name}</h6>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="editPotName(${pot.pot_id}, '${pot.pot_name || pot.name}')">
                            <i class="fas fa-edit"></i> Bearbeiten
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePot(${pot.pot_id})">
                            <i class="fas fa-trash"></i> Löschen
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading pots:', error);
    });
}

function editPotName(potId, currentName) {
    const newName = prompt('Neuer Name für den Topf:', currentName);
    if (newName && newName !== currentName) {
        updatePot(potId, newName);
    }
}

function loadPlantsForSelect() {
    fetch('/json/plants?user_mail={{ session.user_id }}')
    .then(response => response.json())
    .then(plants => {
        const select = document.getElementById('selectPlant');
        select.innerHTML = '<option value="">Bitte wählen...</option>' + 
            plants.map(plant => `<option value="${plant.plant_id}">${plant.name}</option>`).join('');
    });
}

function loadPotsForSelect() {
    fetch('/json/pots?user_mail={{ session.user_id }}')
    .then(response => response.json())
    .then(pots => {
        const select = document.getElementById('selectPot');
        select.innerHTML = '<option value="">Bitte wählen...</option>' + 
            pots.map(pot => `<option value="${pot.pot_id}">${pot.pot_name || pot.name}</option>`).join('');
    });
}

function loadPotsForUserSelect() {
    fetch('/json/pots?user_mail={{ session.user_id }}')
    .then(response => response.json())
    .then(pots => {
        const select = document.getElementById('selectPotUser');
        select.innerHTML = '<option value="">Bitte wählen...</option>' + 
            pots.map(pot => `<option value="${pot.pot_id}">${pot.pot_name || pot.name}</option>`).join('');
    });
}

function loadAssignments() {
    // This would need additional API endpoints to load existing assignments
    // For now, we'll just show placeholder text
    document.getElementById('plant-pot-assignments').innerHTML = '<p class="text-muted">Zuweisungen werden hier angezeigt...</p>';
    document.getElementById('user-pot-assignments').innerHTML = '<p class="text-muted">Zuweisungen werden hier angezeigt...</p>';
}
</script>
{% endblock %}